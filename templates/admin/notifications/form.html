{{define "admin/notifications/form.html"}}
<!DOCTYPE html>
<html>
<head>
    <title>Email Notifications Configuration</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .provider-settings { 
            display: none; 
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .provider-settings.active { display: block; }
        .success-message {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Email Notifications Configuration</h1>
        <p>Configure email notifications for comment events.</p>

        {{if .Success}}
        <div class="success-message">
            Configuration saved successfully!
        </div>
        {{end}}

        <form method="POST" action="/admin/sites/{{.SiteID}}/notifications" class="notifications-form">
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="enabled" {{if .Settings.Enabled}}checked{{end}}>
                    Enable Email Notifications
                </label>
                <p class="help-text">Turn on email notifications for this site</p>
            </div>

            <h3>Email Provider</h3>
            <div class="form-group">
                <label for="provider">Provider</label>
                <select id="provider" name="provider" onchange="toggleProvider(this.value)">
                    <option value="smtp" {{if eq .Settings.Provider "smtp"}}selected{{end}}>SMTP</option>
                    <option value="sendgrid" {{if eq .Settings.Provider "sendgrid"}}selected{{end}}>SendGrid</option>
                </select>
                <p class="help-text">Choose your email delivery provider</p>
            </div>

            <h3>Sender Information</h3>
            <div class="form-group">
                <label for="from_email">From Email *</label>
                <input type="email" id="from_email" name="from_email" value="{{.Settings.FromEmail}}" required>
                <p class="help-text">Email address that notifications will be sent from</p>
            </div>

            <div class="form-group">
                <label for="from_name">From Name *</label>
                <input type="text" id="from_name" name="from_name" value="{{.Settings.FromName}}" required>
                <p class="help-text">Display name for the sender (e.g., "MySite Comments")</p>
            </div>

            <div class="form-group">
                <label for="reply_to">Reply-To Email</label>
                <input type="email" id="reply_to" name="reply_to" value="{{.Settings.ReplyTo}}">
                <p class="help-text">Optional: Email address for replies</p>
            </div>

            <div class="form-group">
                <label for="owner_email">Site Owner Email *</label>
                <input type="email" id="owner_email" name="owner_email" value="{{.Settings.OwnerEmail}}" required>
                <p class="help-text">Email address to receive site notifications</p>
            </div>

            <!-- SMTP Settings -->
            <div id="smtp-settings" class="provider-settings {{if eq .Settings.Provider "smtp"}}active{{end}}">
                <h3>SMTP Configuration</h3>
                
                <div class="form-group">
                    <label for="smtp_host">SMTP Host *</label>
                    <input type="text" id="smtp_host" name="smtp_host" value="{{.Settings.SMTPHost}}">
                    <p class="help-text">SMTP server hostname (e.g., smtp.gmail.com)</p>
                </div>

                <div class="form-group">
                    <label for="smtp_port">SMTP Port *</label>
                    <input type="number" id="smtp_port" name="smtp_port" value="{{if .Settings.SMTPPort}}{{.Settings.SMTPPort}}{{else}}587{{end}}">
                    <p class="help-text">Common ports: 587 (STARTTLS), 465 (TLS), 25 (plain)</p>
                </div>

                <div class="form-group">
                    <label for="smtp_user">SMTP Username</label>
                    <input type="text" id="smtp_user" name="smtp_user" value="{{.Settings.SMTPUser}}">
                    <p class="help-text">Authentication username (often your email address)</p>
                </div>

                <div class="form-group">
                    <label for="smtp_password">SMTP Password</label>
                    <input type="password" id="smtp_password" name="smtp_password" placeholder="{{if .Settings.SMTPPassword}}••••••••{{end}}">
                    <p class="help-text">Authentication password (leave blank to keep existing)</p>
                </div>

                <div class="form-group">
                    <label for="smtp_encryption">Encryption</label>
                    <select id="smtp_encryption" name="smtp_encryption">
                        <option value="tls" {{if eq .Settings.SMTPEncryption "tls"}}selected{{end}}>TLS (Port 465)</option>
                        <option value="starttls" {{if eq .Settings.SMTPEncryption "starttls"}}selected{{end}}>STARTTLS (Port 587)</option>
                        <option value="none" {{if eq .Settings.SMTPEncryption "none"}}selected{{end}}>None (Not recommended)</option>
                    </select>
                    <p class="help-text">Encryption method for secure connection</p>
                </div>
            </div>

            <!-- SendGrid Settings -->
            <div id="sendgrid-settings" class="provider-settings {{if eq .Settings.Provider "sendgrid"}}active{{end}}">
                <h3>SendGrid Configuration</h3>
                
                <div class="form-group">
                    <label for="sendgrid_api_key">SendGrid API Key *</label>
                    <input type="password" id="sendgrid_api_key" name="sendgrid_api_key" placeholder="{{if .Settings.SendGridAPIKey}}••••••••{{end}}">
                    <p class="help-text">Your SendGrid API key (leave blank to keep existing)</p>
                </div>

                <div class="info-box">
                    <p><strong>Note:</strong> Get your API key from <a href="https://app.sendgrid.com/settings/api_keys" target="_blank">SendGrid Dashboard</a></p>
                </div>
            </div>

            <h3>Notification Types</h3>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="notify_new_comment" {{if .Settings.NotifyNewComment}}checked{{end}}>
                    New Comments
                </label>
                <p class="help-text">Notify site owner when a new comment is posted</p>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="notify_reply" {{if .Settings.NotifyReply}}checked{{end}}>
                    Comment Replies
                </label>
                <p class="help-text">Notify users when someone replies to their comment</p>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="notify_moderation" {{if .Settings.NotifyModeration}}checked{{end}}>
                    Moderation Updates
                </label>
                <p class="help-text">Notify users when their comment is approved or rejected</p>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Configuration</button>
                <button type="button" class="btn btn-secondary" onclick="testEmail()">Send Test Email</button>
                <a href="/admin/sites/{{.SiteID}}" class="btn btn-secondary">Back to Site</a>
            </div>

            <div id="form-response"></div>
        </form>

        <div class="info-box">
            <h3>How It Works</h3>
            <ul>
                <li><strong>New Comments:</strong> Site owner receives an email when a new comment is posted</li>
                <li><strong>Replies:</strong> Users receive an email when someone replies to their comment</li>
                <li><strong>Moderation:</strong> Users are notified when their comment is approved or rejected</li>
                <li><strong>Queue Processing:</strong> Emails are queued and sent in the background</li>
            </ul>
        </div>

        <div class="info-box">
            <h3>Common SMTP Settings</h3>
            <ul>
                <li><strong>Gmail:</strong> smtp.gmail.com:587 (STARTTLS) - Use App Password</li>
                <li><strong>Office 365:</strong> smtp.office365.com:587 (STARTTLS)</li>
                <li><strong>AWS SES:</strong> email-smtp.region.amazonaws.com:587 (STARTTLS)</li>
                <li><strong>Mailgun:</strong> smtp.mailgun.org:587 (STARTTLS)</li>
            </ul>
        </div>
    </div>

    <script>
        function toggleProvider(provider) {
            document.getElementById('smtp-settings').classList.remove('active');
            document.getElementById('sendgrid-settings').classList.remove('active');
            document.getElementById(provider + '-settings').classList.add('active');
        }

        function testEmail() {
            const siteId = '{{.SiteID}}';
            const email = document.getElementById('owner_email').value;
            
            if (!email) {
                alert('Please enter an owner email address');
                return;
            }

            fetch(`/admin/sites/${siteId}/notifications/test?email=${encodeURIComponent(email)}`, {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                return response.text().then(text => { throw new Error(text); });
            })
            .then(message => {
                alert('Success: ' + message);
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }
    </script>
</body>
</html>
{{end}}
